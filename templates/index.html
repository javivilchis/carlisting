<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Python Car Listings application</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>

<body>
  <div class="container">
    <h1>Python Car Listings application</h1>
    <p>Welcome to the Python Car Listings application using Flask, SQLite, and Jinja2 templating. We hope you can use
      this scaffold to build a full-featured car listing application.</p>
    <div class="form-container">
      <h2>Add a New Car</h2>
      <form id="carForm" onsubmit="return false;">
        <input type="text" name="make" placeholder="Make (e.g. Toyota)" required>
        <input type="text" name="model" placeholder="Model (e.g. Camry)" required>
        <input type="number" name="year" placeholder="Year" required>
        <input type="text" name="color" placeholder="Color">
        <label for="image_file">Car Image:</label>
        <input type="file" name="image_file" accept="image/*">
        <button type="submit">List Car</button>
      </form>
    </div>

    <div class="car-grid">
      {% for car in data %}
      <div class="car-card">
        <!-- Left Side: Image -->
        <div class="car-image">
          {% if car.image_file %}
          <img src="{{ url_for('static', filename='uploads/' + car.image_file) }}" alt="{{ car.make }}">
          {% else %}
          <div class="no-image">No Image Available</div>
          {% endif %}
        </div>

        <!-- Right Side: Details -->
        <div class="car-info">
          <div class="car-title">{{ car.make }} {{ car.model }}</div>
          <div class="car-detail"><strong>Year:</strong> {{ car.year }}</div>
          <div class="car-detail"><strong>Price:</strong> ${{ "{:,.0f}".format(car.price) if car.price else 'N/A' }}
          </div>
          <div class="car-detail"><strong>Mileage:</strong> {{ "{:,}".format(car.mileage) if car.mileage else 'N/A' }}
            miles</div>
          <div class="car-detail"><strong>Color:</strong> {{ car.color or 'N/A' }}</div>
          <div class="car-detail"><strong>Fuel Type:</strong> {{ car.fuel_type or 'N/A' }}</div>
          <div class="car-detail"><strong>Transmission:</strong> {{ car.transmission or 'N/A' }}</div>
        </div>
        <div class="card-actions" style="margin-top: 15px; display: flex; gap: 10px;">
          <a href="{{ url_for('car_details', car_id=car.id) }}" class="btn-view">View Details</a>
          <button onclick="deleteCar({{ car.id }})" class="btn-delete">Delete</button>
        </div>
      </div>
      {% else %}
      <p class="empty-state">No cars found.</p>
      {% endfor %}
    </div>


    <script>

      async function deleteCar(id) {
        if (confirm("Are you sure you want to delete this listing?")) {
          try {
            const response = await fetch(`/api/cars/${id}`, {
              method: 'DELETE'
            });

            if (response.ok) {
              location.reload();
            } else {
              const result = await response.json();
              alert("Error: " + (result.error || "Could not delete car."));
            }
          } catch (error) {
            console.error("Delete error:", error);
            alert("Failed to connect to the server.");
          }
        }
      }
      // Make sure this is wrapped in a DOMContentLoaded or at the bottom of the page
      document.addEventListener('DOMContentLoaded', () => {

        const carForm = document.getElementById('carForm');

        carForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          // 1. Capture all fields (text AND files) directly into FormData
          const formData = new FormData(e.target);

          try {
            const response = await fetch('/api/cars', {
              method: 'POST',
              // 2. IMPORTANT: Do NOT set 'Content-Type' headers. 
              // The browser needs to set it automatically to include the file boundary.
              body: formData
            });

            const result = await response.json();
            if (response.ok) {
              alert("Success! Car added.");
              location.reload();
            } else {
              alert("Error: " + (result.error || result.message));
            }
          } catch (error) {
            console.error("Fetch error:", error);
            alert("Failed to connect to the server.");
          }
        });
      });

    </script>


  </div>
</body>

</html>